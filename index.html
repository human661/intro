<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚ ì”¨ ë° ë¯¸ì„¸ë¨¼ì§€ ì¡°íšŒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #333;
            color: white;
            padding: 20px;
            font-size: 24px;
        }
        section {
            padding: 20px;
        }
        input {
            padding: 10px;
            width: 200px;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #weatherResult {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
        }
        canvas {
            max-width: 600px;
            margin: 20px auto;
        }
    </style>
</head>
<body>

    <header>
        ğŸŒ¤ ì§€ì—­ë³„ ë‚ ì”¨ ë° ë¯¸ì„¸ë¨¼ì§€ ì¡°íšŒ
    </header>

    <section>
        <h2>ë‚ ì”¨ë¥¼ í™•ì¸í•  ì§€ì—­ì„ ì…ë ¥í•˜ì„¸ìš”</h2>
        <input type="text" id="cityInput" placeholder="ì˜ˆ: ì„œìš¸">
        <button onclick="getWeather()">ë‚ ì”¨ í™•ì¸</button>
        
        <div id="weatherResult"></div>
        <canvas id="weatherChart"></canvas>
    </section>

    <script>
        let weatherChart = null; // ê·¸ë˜í”„ ê°ì²´ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸

        async function getWeather() {
            const apiKey = "24109ddecb29a5405afe2a8df42c5e34"; // API í‚¤
            const city = document.getElementById("cityInput").value;
            const weatherResult = document.getElementById("weatherResult");

            if (!city) {
                weatherResult.innerHTML = "<p style='color:red;'>âš  ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.</p>";
                return;
            }

            // ë‚ ì”¨ API ìš”ì²­
            const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric&lang=kr`;
            console.log("ë‚ ì”¨ API ìš”ì²­ URL:", weatherUrl);

            try {
                const weatherResponse = await fetch(weatherUrl);
                const weatherData = await weatherResponse.json();
                console.log("ë‚ ì”¨ API ì‘ë‹µ:", weatherData);

                if (weatherData.cod === 200) {
                    const temp = weatherData.main.temp;
                    const humidity = weatherData.main.humidity;
                    const windSpeed = weatherData.wind.speed;
                    const icon = weatherData.weather[0].icon;
                    const lat = weatherData.coord.lat;
                    const lon = weatherData.coord.lon;

                    // ë¯¸ì„¸ë¨¼ì§€ API ìš”ì²­
                    const airPollutionUrl = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`;
                    console.log("ë¯¸ì„¸ë¨¼ì§€ API ìš”ì²­ URL:", airPollutionUrl);

                    const airResponse = await fetch(airPollutionUrl);
                    const airData = await airResponse.json();
                    console.log("ë¯¸ì„¸ë¨¼ì§€ API ì‘ë‹µ:", airData);

                    if (!airData.list || airData.list.length === 0) {
                        throw new Error("ë¯¸ì„¸ë¨¼ì§€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }

                    const pm2_5 = airData.list[0].components.pm2_5; // ë¯¸ì„¸ë¨¼ì§€ (PM2.5) ê°’
                    const pmLevel = getPMLevel(pm2_5); // ë¯¸ì„¸ë¨¼ì§€ 1~5ë‹¨ê³„ ë³€í™˜

                    weatherResult.innerHTML = `
                        <h3>ğŸ“ ${city}ì˜ ë‚ ì”¨</h3>
                        <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="ë‚ ì”¨ ì•„ì´ì½˜">
                        <p>ğŸŒ¡ ì˜¨ë„: ${temp}Â°C</p>
                        <p>ğŸ’§ ìŠµë„: ${humidity}%</p>
                        <p>ğŸ’¨ í’ì†: ${windSpeed} m/s</p>
                        <p>ğŸŒ« ë¯¸ì„¸ë¨¼ì§€ (PM2.5): ${pm2_5} Âµg/mÂ³ (ë“±ê¸‰: ${pmLevel}/5)</p>
                    `;

                    drawChart(temp, humidity, windSpeed, pmLevel);
                } else {
                    throw new Error(`ë‚ ì”¨ ë°ì´í„° ì˜¤ë¥˜: ${weatherData.message}`);
                }
            } catch (error) {
                console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
                weatherResult.innerHTML = `<p style='color:red;'>âš  ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
            }
        }

        // ë¯¸ì„¸ë¨¼ì§€ 1~5ë“±ê¸‰ ë³€í™˜ í•¨ìˆ˜
        function getPMLevel(pm2_5) {
            if (pm2_5 <= 15) return 1;  // ì¢‹ìŒ
            if (pm2_5 <= 35) return 2;  // ë³´í†µ
            if (pm2_5 <= 75) return 3;  // ë‚˜ì¨
            if (pm2_5 <= 150) return 4; // ë§¤ìš° ë‚˜ì¨
            return 5;                   // ìµœì•…
        }

        // ê·¸ë˜í”„ ìƒì„± í•¨ìˆ˜
        function drawChart(temp, humidity, windSpeed, pmLevel) {
            const ctx = document.getElementById("weatherChart").getContext("2d");

            // ê¸°ì¡´ ê·¸ë˜í”„ ì‚­ì œ
            if (weatherChart !== null) {
                weatherChart.destroy();
            }

            // ìƒˆë¡œìš´ ê·¸ë˜í”„ ìƒì„±
            weatherChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["ì˜¨ë„ (Â°C)", "ìŠµë„ (%)", "í’ì† (m/s)", "ë¯¸ì„¸ë¨¼ì§€ (ë“±ê¸‰)"],
                    datasets: [{
                        label: "ë‚ ì”¨ ë°ì´í„°",
                        data: [temp, humidity, windSpeed, pmLevel],
                        backgroundColor: ["red", "blue", "green", "purple"]
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    </script>

</body>
</html>
